# Feature Specification: Coupon Flow Adjustments

**Feature Branch**: `011-coupon-flow-adjustments`
**Created**: 2026-01-07
**Status**: Draft
**Input**: User description: "新增优惠券流程调整..."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Create Coupon with Flexible Validity (Priority: P1)

As an administrator, I want to create a new coupon with configurable validity rules (either fixed dates or dynamic duration) so that I can run different types of marketing campaigns.

**Why this priority**: Core functionality for coupon creation; dynamic validity is a key new requirement for "birthday" or "post-purchase" style coupons.

**Independent Test**: Can be tested by creating two separate coupons (one fixed, one dynamic) and verifying their configurations are saved and displayed correctly.

**Acceptance Scenarios**:

1. **Given** I am on the Create Coupon page, **When** I fill in basic info and select "Same as Template Validity", **Then** the coupon validity strictly follows the start/end dates of the template.
2. **Given** I am on the Create Coupon page, **When** I select "Dynamic Duration", **Then** I can input "Effect after X days" and "Valid for Y Days/Months/Years".
3. **Given** I am entering the Identifier, **When** I leave it default, **Then** the system automatically generates a unique ID.
4. **Given** I am entering the Identifier, **When** I choose manual entry, **Then** I can input a custom string (validated for uniqueness).

---

### User Story 2 - Configure Usage & Store Limits (Priority: P2)

As an administrator, I want to restrict how many coupons can be issued and where they can be used, so that I can control campaign budget and scope.

**Why this priority**: Essential for fraud prevention and budget control.

**Independent Test**: Create a coupon with specific quotas (e.g., Total 100, 1 per User) and Store restrictions, then verify these settings are persisted.

**Acceptance Scenarios**:

1. **Given** the Issuance Limits section, **When** I enter a "Total Quota", **Then** the system records the maximum global number of coupons.
2. **Given** the Per User Quota section, **When** I set "Max 1" and "Frequency: All Time", **Then** a user can only claim this once.
3. **Given** the Per User Quota section, **When** I set "Max 1" and "Frequency: Monthly", **Then** a user can claim one every month.
4. **Given** the Redemption Constraints, **When** I select specific stores, **Then** the coupon is marked as valid only for those locations.

### Edge Cases

- **Invalid Date Logic**: 
    - End Date is set before Start Date in Template Validity.
    - Dynamic Validity configured with negative days.
- **Duplicate Identifier**: User manually enters an Identifier that is already claimed by another active coupon.
- **Conflicting Quotas**: User sets a "Per User" limit that exceeds the "Total Quota".
- **Zero Value**: User attempts to create a "Cash" coupon with 0 value.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST collect Basic Information:
    - Name (Text)
    - Identifier (Auto-generated by default, switchable to Manual input)
    - Type (Selection: Cash, Discount Percentage, Product/Service)
    - Value (Numeric for Cash/Discount, Text/Numeric for Product)
    - Image (Upload/Selection)
    - Description (Rich Text/Text)
    - Terms & Conditions (Rich Text/Text)
    - Template Validity (Start Date - End Date)
- **FR-002**: System MUST support two choices for "Union Code Validity" (Coupon Instance Validity):
    - **Option A (Default)**: Follows Template Validity (Start/End Date).
    - **Option B (Dynamic)**: Configurable "Effective after X days" (delay from **Date of Claim**) and "Valid for Y Days/Weeks/Months/Years" (duration).
- **FR-003**: System MUST enforce Issuance Limits:
    - **Total Quota**: Maximum total coupons distributable.
    - **Per User Quota**: Configurable count (X) per period (Y Days/Weeks/Months OR "All Time").
- **FR-004**: System MUST support Store inputs for "Redemption Limits" (Allowlist of stores).
- **FR-005**: System MUST validate that required fields (Name, Type, Value) are present before saving.

### Key Entities

- **CouponTemplate**: Defines the rules and structure (Name, Type, Limits, Validity Configuration).
- **CouponValidityConfig**: Sub-structure storing the validity logic (Type: Fixed/Dynamic, Delay parameters, Duration parameters).
- **QuotaConfig**: Sub-structure storing limiting logic (Global Limit, User Limit, Frequency).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Admins can successfully create a coupon with "Dynamic Validity" settings in under 2 minutes.
- **SC-002**: 100% of created coupons correctly persist the chosen "Identifier" mode (Auto vs Manual).
- **SC-003**: Per-user frequency limits (e.g., "1 per Week") are correctly stored and retrieved.
- **SC-004**: Data validation prevents 100% of attempts to create coupons with missing mandatory fields (Name, Value).
